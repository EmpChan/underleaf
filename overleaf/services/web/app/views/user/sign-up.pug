extends ../layout-marketing

block content
	main#main-content.content.content-alt
		.container
			.row
				.col-lg-6.offset-lg-3.col-xl-4.offset-xl-4
					.card
						.card-body
							.page-header
								h1 #{translate("sign_up")}
							form(name='signupForm' action='/sign-up' method='POST')
								input(name='_csrf' type='hidden' value=csrfToken)
								
								.form-group
									label(for='email') #{translate("email")}
									input#email.form-control(
										name='email'
										type='email'
										required
										autofocus='true'
										autocomplete='username'
									)
								
								.form-group
									label(for='password') #{translate("password")}
									input#password.form-control(
										name='password'
										type='password'
										required
										autocomplete='new-password'
									)

								.form-group
									label(for='confirmPassword') #{translate("confirm_password")}
									input#confirmPassword.form-control(
										name='confirmPassword'
										type='password'
										required
										autocomplete='new-password'
									)

								.actions
									button.btn-primary.btn(type='submit' data-ol-disabled-inflight)
										span(data-ol-inflight='idle') #{translate("sign_up")}
										span(hidden data-ol-inflight='pending') #{translate("signing_up")}…
								
							script(nonce=scriptNonce).
								(function () {
									const form = document.querySelector('form[name="signupForm"]')
									if (!form) return

									form.addEventListener('submit', async e => {
										e.preventDefault();

										const params = new URLSearchParams(new FormData(form));
										const res = await fetch(form.action, {
											method: 'POST',
											body: params,
											headers: {
												'Accept': 'application/json',
												'Content-Type': 'application/x-www-form-urlencoded'
											}
										});
										const text = await res.text();
										let data = {};
										try { data = JSON.parse(text) } catch {}
										console.log('Signup response data:', data);
										console.log('Signup response info:', data.info);
										console.log('Signup response error:', data.error);
										console.log('Signup response redirect:', data.redirect);
										if (data.redirect) {
											alert('회원가입이 완료되었습니다. 환영합니다!');
											window.location.assign(data.redirect);
											return // 여기서 종료
										}

										const key = data.error || data.msg || data?.info?.key
										console.log('Signup response key:', key);

										const MSG = {
											passwordMismatch: '비밀번호가 일치하지 않습니다.',
											duplicateEmail: '이미 등록된 이메일 주소입니다.',
											invalidDomain: '허용된 이메일 도메인만 사용할 수 있습니다.',
											passwordNotSet: '비밀번호를 입력해주세요.',
											passwordIsTooShort: '비밀번호가 너무 짧습니다. 8자 이상 작성해 주세요.',
											passwordIsTooLong: '비밀번호가 너무 깁니다. 72자 미만으로 작성해 주세요.',
											passwordContainsAnInvalidCharacter: '비밀번호에 허용되지 않는 문자가 포함되어 있습니다.',
											passwordContainsPartOfEmailAddress: '비밀번호에 이메일 주소의 일부가 포함되어 있습니다.',
											passwordIsTooSimilarToEmailAddress: '비밀번호가 이메일 주소와 너무 유사합니다.',
											generalError: '회원가입 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
										}
										alert(MSG[key] || MSG.generalError)
										});
								})()
